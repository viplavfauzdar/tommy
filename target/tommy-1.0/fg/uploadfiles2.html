<!DOCTYPE html>
<link href="stylesheets/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css" />
<link href="stylesheets/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css" />
<link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,300italic,400italic,700,700italic,900' rel='stylesheet'>
<link href='http://fonts.googleapis.com/css?family=Raleway:400,600,700' rel='stylesheet' />
<link href="stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />   
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
<link href="stylesheets/jasny-bootstrap.min.css" media="screen" rel="stylesheet" type="text/css" />
<script src="javascripts/jasny-bootstrap.min.js"></script>

<!--<script src="js/vendor/jquery.ui.widget.js"></script>
<script src="js/jquery.iframe-transport.js"></script>
<script src="js/jquery.fileupload.js"></script>-->

<section>
    <div class='row-fluid'>
        <div class='col-md-12 text-center'>
            <div class='row'>
                <div class='col-md-3 text-left'>
                    <h2>Upload Images & Business Documents</h2>
                    <h3>Only images and pdf files less than 5 MB are allowed</h3>
                    <!--<input class="form-control" type="file" id="file1" accept="image/gif, image/jpeg, image/png, application/pdf" data-url="/Uploader?action=upload">-->
                    <!-- can use only file input type on a page -->    
                </div>                            
                <div class='col-md-9 text-left'>                         

                    <table>
                        <tr>
                            <td>                                
                                <div class='input-group'>
                                    <!--                                    <input type="text" id="userId" name="userId">-->
                                    <h4>Profile Picture</h4>
                                    <h5>Please upload a profile picture</h5>  
                                    <div id="profilePic"></div>
                                </div>                                

                                <div class='input-group'>
                                    <h4>Business Logo</h4>
                                    <h5>Please upload a logo picture</h5>
                                    <div id="businessLogo"></div>
                                </div>

                                <div class='input-group'>
                                    <h4>Business Picture 1</h4>
                                    <h5>Please upload a business picture</h5>
                                    <div id="businessPic1"></div>
                                </div>

                                <div class='input-group'>
                                    <h4>Business Picture 2</h4>
                                    <h5>Please upload a business picture</h5>
                                    <div id="businessPic2"></div>
                                </div>

                                <div class='input-group'>
                                    <h4>Executive Summary</h4>
                                    <h5>Please upload Executive Summary PDF</h5>
                                    <div id="execSumm"></div>
                                </div>

                                <div class='input-group'>
                                    <h4>Business Plan</h4>
                                    <h5>Please upload Business Plan PDF</h5>
                                    <div id="businessPlan"></div>
                                </div>

                                <div class='input-group'>
                                    <h4>Financials</h4>
                                    <h5>Please upload Financials PDF</h5>
                                    <div id="financials"></div>
                                </div>

                            </td>
                        </tr>                            

                        <td>
                            <button class='btn btn-default' id="btnContinue">Continue</button>
                        </td>
                        </tr>
                    </table>                                               

                </div>
            </div>
        </div>
    </div>
</section>

<script src="javascripts/bootstrap.min.js" type="text/javascript"></script>

<script>

    //$( "#accordion" ).accordion(); //look into it. messes up with bootstrap

    //document.getElementById("userId").value = userId;
    userId = $("#userId").val();

    $("[data-toggle=tooltip]").tooltip();

    //** incase of missing pics or pics that didn't load
    $("img").error(function () {
        $(this).unbind("error").attr("src", "img/placeholder.jpg");
    });

    var fgAlert = function (msg) {
        $("body").append('<div id="fgalert" class="alert alert-info fade in" style="position:absolute;top:40%;left:40%;z-index:100">' +
                '<button type="button" class="close" data-dismiss="alert">&nbsp;&nbsp;Ã—</button>' + msg + '</div>');
        $('fgalert').show();
    }

    var fgUploader = function (elem) {
        //<input class="form-control" type="file" id="file1_' + elem.attr('id') +
        //        '" name="files[]" accept="image/gif, image/jpeg, image/png, application/pdf" multiple>'        
        var uplmarkup = '<table>' +
                '<tr><td>' +
                '<div class="fileinput fileinput-new" data-provides="fileinput">' +
                '<a id="lnkFile" name="lnkFile" target="_blank"><div class="fileinput-preview thumbnail" data-trigger="fileinput" style="width: 200px; height: 150px;"></div></a>' +
                '<div><span class="btn btn-default btn-file"><span class="fileinput-new">Select image</span><span class="fileinput-exists">Change</span>' + 
                '<input type="file" id="file1_' + elem.attr('id') + '" name="..." accept="image/gif, image/jpeg, image/png, application/pdf"></span>' +
                '<a href="#" class="btn btn-default fileinput-exists" data-dismiss="fileinput">Remove</a></div></div>' +
                '<button class="btn btn-default orange" id="btnUpload">Upload</button>' +
                '<button class="btn btn-default" id="btnDelete">Delete</button>' +
                '<div class="progress">' +
                '<div class="progress-bar" role="progressbar" style="width: 0%;"></div>' +
                '</div>' +
                '<td>' +
                '</table>';
        //<a target="_blank"><img id="img1" data-toggle="tooltip" data-placement="left" title="Click to Enlarge!" class="thumbnail"' +
        //        'style="height: 200px; width: 200px; cursor: hand; cursor: pointer;"></a>
        //onclick=\'window.open(this.src, "_blank")\'
        $(elem).html(uplmarkup);
    };

    function uploadFile(elemId, filename) {
        console.log(elemId);
        $("#" + elemId).find("img").attr("src", ""); //remove any previous pic still displaying
        //var fileSelect = document.getElementById("file1"); //can have only one file input per page otherwise they all get same file
        var fileSelect = document.getElementById($("#" + elemId).find("input[type=file]").attr("id"));
        //fileSelect = document.getElementById($("#" + elemId + " input").attr("id"));
        console.log(fileSelect.value);
        if (fileSelect.value == "")
            fgAlert("Please select a file first! ");
        var files = fileSelect.files;
        var formData = new FormData();
        formData.append('myfile', files[0], files[0].name);
        ext = files[0].name.split('.').pop();
        if (filename == "")
            filename = files[0].name;
        else
            filename = filename + "." + ext;
        var xmlhttp = new XMLHttpRequest();
        i = 0;
        thumburl = "/Uploader?action=stream&folder=" + userId + "&filename=" + filename;
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                console.log(xmlhttp.responseText);
                if (xmlhttp.responseText.match("uploaded")) {
                    $("#" + elemId).find("#lnkFile").attr("href", window.location.origin + thumburl + "&t=" + Math.random());
                    //$("#" + elemId).find("img").attr("src", window.location.origin + thumburl + "&t=" + Math.random());
                    $("#" + elemId).find(".progress-bar").css("width", "100%");
                    $("#" + elemId).find(".progress-bar").html("100%");
                    $("img").error(function () {
                        $(this).unbind("error").attr("src", "img/pdf.png");
//                        $(this).unbind("error").wrap("<a href='" + thumburl + "&t=" + Math.random() + "' target='_blank'></a>");    
//                        $(this).unbind("error").removeAttr("onclick");
                    }); //opens this image instead of the pdf. thats why wrap in <a>/ alt I can change fgUploader above
                }
            } else {
                i++;
                $("#" + elemId).find(".progress-bar").css("width", i * 25 + "%");
                $("#" + elemId).find(".progress-bar").html(i * 25 + "%");
            }
        }
        xmlhttp.open("POST", "/Uploader?action=upload&folder=" + userId + "&filename=" + filename, true);
        xmlhttp.send(formData);
    }

    function deleteFile(url) {
        var retval = false;
        $.ajax({
            type: "POST",
            url: url,
            async: false,
            complete: function (res) {
                //console.log(JSON.stringify(res)); //spits out all file bytes in console
            },
            success: function (res1) {
                //console.log(res1); //spits out all file bytes in console
                retval = true;
            }
        });
        return retval;
    }

    var render = function (elemId) {
        fgUploader($("#" + elemId));
        $("#" + elemId).find("#btnUpload").click(function () {
            uploadFile(elemId, elemId);
        });
        $("#" + elemId).find("#btnDelete").click(function () {
            srcurl = $("#" + elemId).find("#lnkFile").attr("href");
            console.log(srcurl);
//            if(srcurl=='img/pdf.png') srcurl = $("#" + elemId).find("img").parent().attr("href");
//            console.log(srcurl);
            if (deleteFile(srcurl.replace("action=stream", "action=delete"))) {
                console.log(srcurl);
                $("#" + elemId).find("img").removeAttr("src");
                $("#" + elemId).find("img").parent().removeAttr("href");
                $("#" + elemId).find(".progress-bar").css("width", "0%");
                $("#" + elemId).find(".progress-bar").html("");
                $("img").error(function () {
                    $(this).unbind("error").attr("src", "img/pdf.png");
                });
            }
        });
    };

    //render all uploads
    render("profilePic");
    render("businessLogo");
    render("businessPic1");
    render("businessPic2");
    render("execSumm");
    render("businessPlan");
    render("financials");

    $("[data-toggle=tooltip]").tooltip();

</script>

